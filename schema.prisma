// ------------------------------------------------------------
// Afterlife Service â€” Prisma Schema (MongoDB)
// ALL relations explicitly named; enums deduped
// Posts consolidated; Unified Feeds; Event comments enabled
// ------------------------------------------------------------
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URI")
}

// ---------------------- Enums -------------------------------

enum Visibility {
  PUBLIC
  UNLISTED
  PRIVATE
}

enum MemorialStatus {
  ACTIVE
  ARCHIVED
}

enum VerificationStatus {
  UNVERIFIED
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
}

enum ReviewDecision {
  PENDING
  APPROVED
  REJECTED
}

enum FundraisingStatus {
  ACTIVE
  PAUSED
  CLOSED
}

enum DonationStatus {
  SUCCEEDED
  REFUNDED
  FAILED
  PENDING
}

enum ContentFormat {
  IMAGE
  VIDEO
  AUDIO
  TEXT
  STICKER
  LIVESTREAM
}

enum PostStatus {
  DRAFT
  PUBLISHED
  MODERATION_HOLD
  REMOVED
}

enum LivestreamState {
  SCHEDULED
  LIVE
  ENDED
  CANCELED
}

enum RSVPStatus {
  GOING
  MAYBE
  NOT_GOING
  WAITLISTED
  CHECKED_IN
}

enum FollowTargetType {
  USER
  MEMORIAL
}

enum LikeTargetType {
  POST
  COMMENT
}

enum CommentTargetType {
  POST
  EVENT
}

enum FeedType {
  MEMORIAL
  USER
  POST
  CATEGORY
  PROXIMITY
  CUSTOM
}

enum FeedStatus {
  ACTIVE
  EXPIRED
}

enum FeedEventType {
  IMPRESSION
  OPEN
  SCROLL
  CLICK
}

enum FeedItemType {
  MEMORIAL_UPDATE
  FUNDRAISER_UPDATE
  DONATION
  OBITUARY_UPDATE
  EVENT_NOTICE
  AI_SUMMARY
}

enum DecoratorType {
  SALUTATION
  THEME
  STICKER
  BACKGROUND
  ICON
}

enum DecoratorStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum FeedbackCategory {
  PAYOUT_ISSUE
  MEMORIAL_ISSUE
  DONATION_ISSUE
  BUG
  CONTENT_ISSUE
  PRODUCT_FEEDBACK
  POSITIVE_FEEDBACK
  OTHER
}

enum FeedbackSentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

enum FeedbackSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum FeedbackStatus {
  NEW
  IN_REVIEW
  RESOLVED
  DISMISSED
}

enum FeedbackSource {
  WEB
  MOBILE
  SUPPORT_AGENT
  SYSTEM
}

enum FeedbackChannel {
  IN_APP_FORM
  EMAIL_IMPORT
  SUPPORT_API
  OTHER
}

type GeoJsonPoint {
  type        String  @default("Point")
  coordinates Float[]
}

// ---------------------- Users & Sessions --------------------

model User {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  email       String    @unique
  name        String?
  dateOfBirth DateTime? @default(now()) // for age-restricted content
  handle      String?   @unique @default(cuid())
  imageUrl    String?
  status      String    @default("ACTIVE")
  roles       String[]
  lastLogin   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // relations
  sessions              Session[]              @relation(name: "UserSessions")
  follows               Follow[]               @relation(name: "UserFollows")
  likes                 Like[]                 @relation(name: "UserLikes")
  comments              Comment[]              @relation(name: "UserComments")
  posts                 Post[]                 @relation(name: "UserPosts")
  memorialRelationships MemorialRelationship[] @relation(name: "MemorialRelationshipUser")
  feedbackReports       FeedbackReport[]       @relation(name: "UserFeedbackReports")
}

model Session {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  user   User   @relation(name: "UserSessions", fields: [userId], references: [id])

  token     String   @unique
  expiresAt DateTime
  userAgent String?
  ip        String?

  createdAt DateTime @default(now())

  @@index([userId, expiresAt])
}

// ---------------------- Memorials ---------------------------

model Memorial {
  id                       String                 @id @default(auto()) @map("_id") @db.ObjectId
  slug                     String                 @unique
  shortId                  String?                @unique
  ownerUserId              String
  displayName              String
  coverAssetUrl            String?
  coverAssetId             String?                @db.ObjectId
  salutation               String?
  yearOfBirth              Int?
  yearOfPassing            Int?
  theme                    String?                @default("default")
  locationId               String?                @db.ObjectId
  location                 Location?              @relation(fields: [locationId], references: [id])
  point                    GeoJsonPoint?
  bioSummary               String?
  tags                     String[]
  visibility               Visibility             @default(PUBLIC)
  status                   MemorialStatus         @default(ACTIVE)
  verificationStatus       VerificationStatus     @default(UNVERIFIED)
  iosAppUrl                String?
  androidAppUrl            String?
  shareUrl                 String?
  shortUrl                 String?
  obituaryId               String? // latest obituary draft ID
  obituaryServiceSessionId String? // questionnaire session ID
  createdAt                DateTime               @default(now())
  updatedAt                DateTime               @updatedAt
  archivedAt               DateTime?
  verificationCase         VerificationCase?      @relation(name: "MemorialVerification")
  fundraising              FundraisingProgram?    @relation(name: "MemorialFundraising")
  posts                    Post[]                 @relation(name: "PostMemorialPrimary")
  memorialRelationships    MemorialRelationship[] @relation(name: "MemorialRelationshipMemorial")
  decorators               MemorialDecorator[]    @relation(name: "MemorialDecoratorsMemorial")
  feedbackReports          FeedbackReport[]       @relation(name: "MemorialFeedbackReports")

  @@index([displayName])
  @@index([verificationStatus, status])
  @@index([locationId])
}

type ObituaryCaption {
  draftId     String   @db.ObjectId
  captionText String   @db.String
  createdAt   DateTime @default(now())
}

model PublishedObituary {
  id          String           @id @default(auto()) @map("_id") @db.ObjectId
  memorialId  String           @db.ObjectId
  draftId     String           @db.ObjectId
  sessionId   String?          @db.ObjectId
  caption     ObituaryCaption?
  tone        String
  length      String
  content     String
  wordCount   Int?
  version     Int?
  publishedAt DateTime         @default(now())
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([memorialId])
  @@index([draftId])
}

model Location {
  id               String        @id @default(auto()) @map("_id") @db.ObjectId
  googlePlaceId    String?
  formattedAddress String?
  type             String // "RESTING_PLACE" | "AFTERLIFE" | "AR_VIGIL" | etc.
  lat              Float?
  lng              Float?
  city             String?
  state            String?
  point            GeoJsonPoint?
  country          String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  memorials Memorial[]
}

// ---------------------- Verification ------------------------

model VerificationCase {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  memorialId String   @unique @db.ObjectId
  memorial   Memorial @relation(name: "MemorialVerification", fields: [memorialId], references: [id])

  submittedBy String
  inputs      VerificationInputs
  comparison  VerificationComparison?

  status      VerificationStatus @default(PENDING)
  reasonCodes String[]
  decidedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  documents      VerificationDoc[]   @relation(name: "VerificationDocuments")
  providerChecks ProviderCheck[]     @relation(name: "VerificationProviderChecks")
  manualReviews  ManualReview[]      @relation(name: "VerificationManualReviews")
  secrets        VerificationSecret? @relation(name: "VerificationSecrets")

  @@index([status])
}

model VerificationDoc {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  verificationId String           @db.ObjectId
  verification   VerificationCase @relation(name: "VerificationDocuments", fields: [verificationId], references: [id])

  assetId        String
  kind           String // "death_certificate" | "supporting"
  uploadedAt     DateTime
  ocrText        String?
  matchScore     Float?
  verifiedFields String[]
}

model ProviderCheck {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  verificationId String           @db.ObjectId
  verification   VerificationCase @relation(name: "VerificationProviderChecks", fields: [verificationId], references: [id])

  provider   String
  requestId  String?
  matchScore Float?
  result     String? // "match" | "no_match" | "inconclusive"
  raw        Json?

  createdAt DateTime @default(now())

  @@index([verificationId, provider])
}

model ManualReview {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  verificationId String           @db.ObjectId
  verification   VerificationCase @relation(name: "VerificationManualReviews", fields: [verificationId], references: [id])

  reviewerUserId String
  notes          String?
  decision       ReviewDecision @default(PENDING)

  createdAt DateTime  @default(now())
  decidedAt DateTime?
}

model VerificationSecret {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  verificationId String           @unique @db.ObjectId
  verification   VerificationCase @relation(name: "VerificationSecrets", fields: [verificationId], references: [id])

  // Encrypted full SSN (TEMPORARY)
  encFullSsn    String? // base64(ciphertext)
  encSsnIv      String? // base64(iv)
  encSsnAuthTag String? // base64(authTag)

  // Hashed identifiers (LONG-TERM)
  hashedSsn    String? // hash(fullSSN + salt), e.g. Argon2/Bcrypt
  hashedCertId String? // hash(deathCertificateId + salt)

  // Minimal metadata
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  lastUsedAt DateTime? // last time we actually used encFullSsn for DMF
}

type VerificationInputs {
  fullName           String
  dateOfBirth        DateTime?
  dateOfPassing      DateTime?
  ssnLast4           String? // for display/confirmation only
  certificateNumber  String? // OPTIONAL, for human review; treat as sensitive
  state              String?
  county             String?
  deathCertificateId String? // OPTIONAL external ID (never stored in plaintext long-term)
}

type VerificationComparison {
  nameMatchScore         Float?
  dobMatchScore          Float?
  dopMatchScore          Float?
  certificateNumberMatch Float?
  overallScore           Float?
  notes                  String?
}

// ---------------------- Fundraising (mirror) ----------------

model FundraisingProgram {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  memorialId String   @unique @db.ObjectId
  memorial   Memorial @relation(name: "MemorialFundraising", fields: [memorialId], references: [id])

  purpose                     String
  goalAmountCents             Int?
  currentAmountCents          Int               @default(0)
  currency                    String            @default("USD")
  status                      FundraisingStatus @default(ACTIVE)
  feePlanId                   String?
  connectAccountId            String?
  stripeCustomerId            String? // Customer for payout bank account setup
  beneficiaryType             String?
  beneficiaryName             String?
  beneficiaryExternalId       String?
  beneficiaryOnboardingStatus String?           @default("NOT_STARTED")
  totalPayoutsCents           Int               @default(0)
  lastPayoutAt                DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  donations    DonationMirror[] @relation(name: "ProgramDonations")
  payouts      PayoutMirror[]   @relation(name: "ProgramPayouts")
  payoutMethod PayoutMethod?    @relation(name: "ProgramPayoutMethod")

  @@index([status])
  @@index([beneficiaryOnboardingStatus])
}

model DonationMirror {
  id            String             @id @default(auto()) @map("_id") @db.ObjectId
  fundraisingId String             @db.ObjectId
  fundraising   FundraisingProgram @relation(name: "ProgramDonations", fields: [fundraisingId], references: [id])

  billingPaymentId String         @unique
  amountCents      Int
  currency         String
  donorDisplay     String?
  message          String?
  status           DonationStatus
  madeAt           DateTime       @default(now())

  @@index([fundraisingId, status])
  @@index([madeAt])
}

model PayoutMirror {
  id            String             @id @default(auto()) @map("_id") @db.ObjectId
  fundraisingId String             @db.ObjectId
  fundraising   FundraisingProgram @relation(name: "ProgramPayouts", fields: [fundraisingId], references: [id])

  billingPayoutId    String    @unique
  amountCents        Int
  currency           String
  status             String
  initiatedAt        DateTime
  completedAt        DateTime?
  failureReason      String?
  destinationSummary String?
  metadata           Json?

  @@index([fundraisingId, status])
  @@index([initiatedAt])
}

model PayoutMethod {
  id            String             @id @default(auto()) @map("_id") @db.ObjectId
  fundraisingId String             @unique @db.ObjectId
  fundraising   FundraisingProgram @relation(name: "ProgramPayoutMethod", fields: [fundraisingId], references: [id])

  connectAccountId String?
  customerId       String?
  paymentMethodId  String?

  hasBankAccount  Boolean?
  bankLast4       String?
  bankName        String?
  bankCountry     String?
  bankCurrency    String?
  institutionName String?
  payoutsEnabled  Boolean?
  accountStatus   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([connectAccountId])
}

// ---------------------- Posts (Consolidated) ----------------

type BaseMedia {
  mediaType     String // "image" | "video"
  assetId       String
  url           String
  aspectRatio   Float?
  durationMs    Int?
  parentAssetId String?
}

model Post {
  id           String             @id @default(auto()) @map("_id") @db.ObjectId
  authorUserId String?            @db.ObjectId
  author       User?              @relation(name: "UserPosts", fields: [authorUserId], references: [id])
  memorialId   String?            @db.ObjectId // primary memorial (TRIBUTE)
  memorial     Memorial?          @relation(name: "PostMemorialPrimary", fields: [memorialId], references: [id])
  caption      String?
  baseMedia    BaseMedia?
  thumbnail    BaseMedia?
  tags         String[]
  durationMs   Int?
  visibility   Visibility         @default(PUBLIC)
  status       PostStatus         @default(DRAFT)
  publishedAt  DateTime?
  metrics      PostMetrics?
  livestream   LivestreamSession? @relation(name: "PostLivestream")
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  @@index([status, publishedAt])
  @@index([memorialId, publishedAt])
}

type PostMetrics {
  impressions Int @default(0)
  clicks      Int @default(0)
  watchTimeMs Int @default(0)
  likes       Int @default(0)
  flags       Int @default(0)
}

// ---------------------- Activity Feed ----------------------

type FeedCta {
  label         String?
  webUrl        String?
  iosAppUrl     String?
  androidAppUrl String?
}

enum StatementType {
  STRING
  RECORD
}

type Statement {
  text     String
  sourceId String?
  type     StatementType
}

model FeedStatement {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  type          FeedItemType
  parts         Statement[]
  actorUserId   String?      @db.ObjectId
  memorialId    String?      @db.ObjectId
  fundraisingId String?      @db.ObjectId
  obituaryId    String?      @db.ObjectId

  audienceTags    String[]
  audienceUserIds String[]

  lat     Float?
  lng     Float?
  geoHash String?
  country String?

  visibility Visibility?

  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdAt])
  @@index([memorialId, createdAt])
  @@index([country, createdAt])
  @@index([geoHash, createdAt])
}

model UserFeedCursor {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  userId String  @db.ObjectId
  lane   String
  cursor String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, lane])
}

enum MemorialRelationshipKind {
  IMMEDIATE_FAMILY // spouse, parent, child, sibling
  EXTENDED_FAMILY // aunt, uncle, cousin, in-law
  PARTNER // non-married partner
  FRIEND
  COLLEAGUE // coworker, professional connection
  COMMUNITY // church member, neighbor, org member
  CAREGIVER // nurse, aide, hospice, guardian
  OTHER
}

// ---------------------- Consolidated Follows / Likes / Comments ----

model MemorialRelationship {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  memorialId String   @db.ObjectId
  memorial   Memorial @relation(name: "MemorialRelationshipMemorial", fields: [memorialId], references: [id])

  userId String @db.ObjectId
  user   User   @relation(name: "MemorialRelationshipUser", fields: [userId], references: [id])

  relationship MemorialRelationshipKind
  qualifier    String[] // e.g. "sister", "mother", etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([memorialId, userId])
  @@index([memorialId])
  @@index([userId])
}

model Follow {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  userId String @db.ObjectId
  user   User   @relation(name: "UserFollows", fields: [userId], references: [id])

  targetType    FollowTargetType // CREATOR | MEMORIAL
  targetId      String           @db.ObjectId
  notifications String?

  createdAt DateTime @default(now())

  @@unique([userId, targetType, targetId])
  @@index([targetType, targetId])
}

model Like {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  userId String @db.ObjectId
  user   User   @relation(name: "UserLikes", fields: [userId], references: [id])

  targetType LikeTargetType // POST
  targetId   String         @db.ObjectId // Post.id

  createdAt DateTime @default(now())

  @@unique([userId, targetType, targetId])
  @@index([targetType, targetId])
}

model Comment {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  authorUserId String @db.ObjectId
  author       User   @relation(name: "UserComments", fields: [authorUserId], references: [id])

  targetType CommentTargetType // POST | EVENT
  targetId   String            @db.ObjectId // Post.id or Event.id

  body      String
  status    String   @default("VISIBLE") // or MODERATED/REMOVED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parentCommentId String? @db.ObjectId

  @@index([targetType, targetId, createdAt])
  @@index([authorUserId, createdAt])
}

// ---------------------- Feedback Reports -------------------

model FeedbackReport {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  userId String? @db.ObjectId
  user   User?   @relation(name: "UserFeedbackReports", fields: [userId], references: [id])

  memorialId String?   @db.ObjectId
  memorial   Memorial? @relation(name: "MemorialFeedbackReports", fields: [memorialId], references: [id])

  fundraisingId String? @db.ObjectId
  donationId    String? @db.ObjectId
  payoutId      String? @db.ObjectId

  category  FeedbackCategory
  sentiment FeedbackSentiment
  severity  FeedbackSeverity?
  status    FeedbackStatus    @default(NEW)
  source    FeedbackSource?
  channel   FeedbackChannel?

  title       String?
  body        String
  tags        String[]
  attachments Json?

  reporterEmail      String?
  linkedTicketId     String?
  followupRequired   Boolean @default(false)
  consentedToContact Boolean @default(false)
  notifiedUser       Boolean @default(false)

  appVersion String?
  platform   String?
  locale     String?
  timezone   String?
  country    String?
  ipAddress  String?
  userAgent  String?

  resolutionSummary String?
  resolutionAt      DateTime?

  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category, createdAt])
  @@index([status, createdAt])
  @@index([userId, createdAt])
  @@index([memorialId, createdAt])
  @@index([fundraisingId, createdAt])
  @@index([linkedTicketId])
}

// ---------------------- Livestreams --------------------------

model LivestreamSession {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // FK lives here; back-rel on Post/Event
  postId String? @unique @db.ObjectId
  post   Post?   @relation(name: "PostLivestream", fields: [postId], references: [id])

  state       LivestreamState  @default(SCHEDULED)
  ingest      LivestreamIngest
  playbackUrl String?

  startScheduledAt DateTime?
  startedAt        DateTime?
  endedAt          DateTime?

  viewerCount Int      @default(0)
  extras      Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([state])
}

type LivestreamIngest {
  url      String?
  key      String?
  protocol String? // "rtmp" | "webrtc"
}

type Proximity {
  lat     Float
  lng     Float
  radiusM Int
}

model DecoratorCollection {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  slug        String  @unique
  label       String
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  decorators Decorator[]
}

// ---------------------- Decorators -------------------------

model Decorator {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  type        DecoratorType
  label       String
  description String?

  categories String[]
  tags       String[]

  status     DecoratorStatus @default(ACTIVE)
  visibility Visibility      @default(PUBLIC)

  textValue    String?
  assetUrl     String?
  assetType    String?
  assetId      String?
  thumbnailUrl String?
  metadata     Json?
  collectionId String?              @db.ObjectId
  collection   DecoratorCollection? @relation(fields: [collectionId], references: [id])

  createdByUserId String? @db.ObjectId
  updatedByUserId String? @db.ObjectId

  usageCount Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  memorialDecorators MemorialDecorator[] @relation(name: "MemorialDecoratorDecorator")

  @@index([type, status])
  @@index([tags])
  @@index([categories])
  @@index([collectionId])
}

model MemorialDecorator {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  memorialId String   @db.ObjectId
  memorial   Memorial @relation(name: "MemorialDecoratorsMemorial", fields: [memorialId], references: [id])

  decoratorId String    @db.ObjectId
  decorator   Decorator @relation(name: "MemorialDecoratorDecorator", fields: [decoratorId], references: [id])

  appliedByUserId String?   @db.ObjectId
  order           Int       @default(0)
  isPrimary       Boolean   @default(false)
  variant         Json?
  effectiveFrom   DateTime?
  effectiveUntil  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([memorialId, decoratorId])
  @@index([memorialId])
  @@index([decoratorId, isPrimary])
}

// ---------------------- Audit & Logs -------------------------

model AuditLog {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  subjectType String // "Memorial" | "VerificationCase" | "Post" | "Event" | ...
  subjectId   String
  actorUserId String?
  action      String
  payload     Json?
  createdAt   DateTime @default(now())

  @@index([subjectType, subjectId, createdAt])
}
